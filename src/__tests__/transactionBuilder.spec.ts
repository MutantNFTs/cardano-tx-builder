import { toPaymentAddress } from "@mutants/cardano-utils";

import { TransactionBuilder } from "../transaction.builder";
import { RedeemerTag } from "../types";

describe("TransactionBuilder", () => {
  test("should serialize the transaction correctly (Simple ADA send)", () => {
    const builder = new TransactionBuilder();

    builder.setInputs([
      {
        txHash:
          "BEA8C9F1B09994EA260A64ADA27C353948208F849AAD9E37038E3A350AD1127C",
        txIndex: 0,
      },
    ]);

    builder.setOutputs([
      {
        address: toPaymentAddress(
          "01C59DC72AB0BD904DC9A430BD0B6D9D3B3C2D32DFA3DCF5AFFD309002FA02BB733C2B7F9684260BC4B53FB8655CB4B31BFD879A127CF684B2"
        ),
        value: {
          coin: 5000000,
        },
      },
      {
        address: toPaymentAddress(
          "01C59DC72AB0BD904DC9A430BD0B6D9D3B3C2D32DFA3DCF5AFFD309002FA02BB733C2B7F9684260BC4B53FB8655CB4B31BFD879A127CF684B2"
        ),
        value: {
          coin: 42610816,
        },
      },
    ]);

    builder.setTtl(102728211);

    builder.setValidityIntervalStart(0);

    const withdrawals = new Map<Buffer, number>();

    withdrawals.set(
      Buffer.from(
        "E1FA02BB733C2B7F9684260BC4B53FB8655CB4B31BFD879A127CF684B2",
        "hex"
      ),
      133194
    );

    builder.setWithdrawals(withdrawals);

    builder.calculateFee();

    expect(builder.serialize()).toBe(
      // From eternl: 84a60081825820bea8c9f1b09994ea260a64ada27c353948208f849aad9e37038e3a350ad1127c00018282583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b21a004c4b4082583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b21a028a3080021a0002a9b9031a061f821305a1581de1fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b21a0002084a0800a0f5f6
      // We have a slightly higher fee, not sure why
      "84a60081825820bea8c9f1b09994ea260a64ada27c353948208f849aad9e37038e3a350ad1127c000182a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a004c4b40a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a028a3080021a0002ae5d031a061f821305a1581de1fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b21a0002084a0800a0f5f6"
    );
  });

  test("should serialize the transaction correctly (With PlutusV2 script)", () => {
    const builder = new TransactionBuilder();

    builder.setInputs([
      {
        txHash:
          "d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e",
        txIndex: 0,
      },
      {
        txHash:
          "21b0180070427f7be4869d6fde9e74757d51ee7afffa8b8d92fd17ab0c8c4733",
        txIndex: 1,
      },
    ]);

    builder.setOutputs([
      {
        address:
          "addr1q8zem3e2kz7eqnwf5sct6zmdn5anctfjm73aead0l5cfqqh6q2ahx0pt07tggfstcj6nlwr9tj6txxlas7dpyl8ksjeqn8nrly",
        value: {
          coin: 1180940,
          assets: {
            "2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411": {
              "000643b04d5554414e5437383930": 1n,
            },
          },
        },
      },
      {
        address:
          "addr1q8zem3e2kz7eqnwf5sct6zmdn5anctfjm73aead0l5cfqqh6q2ahx0pt07tggfstcj6nlwr9tj6txxlas7dpyl8ksjeqn8nrly",
        value: {
          coin: 11715629,
        },
      },
    ]);

    builder.setPlutusV2Scripts([
      "58BE010000332323232323232323232232222533300A32001323233001375866010601466010601400690002402000C6002002444A66602000429404C8C94CCC03CCDC78010018A5113330050050010033013003375C60220042930B1BAE00133001001480008888CCCC01CCDC38008018059199980280299B8000448008C0340040080088C014DD5000918019BAA0015734AAE7555CF2AB9F5742AE8930011E581C675061014F3EACE588951DE4B7FAB2DC0A7B4BA16C2944DACE6ED5050001",
    ]);

    builder.setCollateralInputs([
      {
        address:
          "addr1q8zem3e2kz7eqnwf5sct6zmdn5anctfjm73aead0l5cfqqh6q2ahx0pt07tggfstcj6nlwr9tj6txxlas7dpyl8ksjeqn8nrly",
        txHash:
          "dd0c087733b576ed3fb415137afdb9bbf00712b7137c5687f180f8e6e30245d1",
        txIndex: 1,
        value: {
          coin: 168053026,
          assets: {
            "2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411": {
              "000de1404d5554414e5433313634": 1n,
              "000de1404d5554414e5433323233": 1n,
              "000de1404d5554414e5433333238": 1n,
              "000de1404d5554414e5434333138": 1n,
              "000de1404d5554414e5434333731": 1n,
              "000de1404d5554414e5434343434": 1n,
              "000de1404d5554414e5434363838": 1n,
              "000de1404d5554414e5435313939": 1n,
              "000de1404d5554414e5435353733": 1n,
              "000de1404d5554414e5435363038": 1n,
              "000de1404d5554414e5436323336": 1n,
              "000de1404d5554414e5436343238": 1n,
              "000de1404d5554414e5436353035": 1n,
              "000de1404d5554414e5437313334": 1n,
              "000de1404d5554414e5437343339": 1n,
              "000de1404d5554414e5437363830": 1n,
              "000de1404d5554414e5437383930": 1n,
            },
            "5b2fa063c299c443dbbad0a186574abbdcbbc323318cccb8f207e224": {
              "5370616365746f6b656e73466f756e646572734e465431303435": 1n,
            },
            "6194158d24d71eca5cc5601c45de123bf78d02c297e851be2608810a": {
              "44454144": 20n,
            },
          },
        },
      },
    ]);

    builder.setRequiredSigners([
      "675061014f3eace588951de4b7fab2dc0a7b4ba16c2944dace6ed505",
    ]);

    const plutusMetadata = new Map<Buffer, unknown>();
    plutusMetadata.set(
      Buffer.from("attributes"),
      new Map<Buffer, Buffer>([
        [Buffer.from("Background"), Buffer.from("Beige")],
        [Buffer.from("Cloth"), Buffer.from("MTTS Purple Hoodie")],
        [Buffer.from("Ear"), Buffer.from("None")],
        [Buffer.from("Eyes"), Buffer.from("Closed")],
        [Buffer.from("Head"), Buffer.from("Orange Beanie")],
        [Buffer.from("Mouth"), Buffer.from("Smirk")],
        [Buffer.from("Nose"), Buffer.from("Common")],
        [Buffer.from("Skin"), Buffer.from("Purple")],
      ])
    );

    plutusMetadata.set(Buffer.from("files"), [
      new Map<Buffer, Buffer>([
        [Buffer.from("mediaType"), Buffer.from("image/png")],
        [Buffer.from("name"), Buffer.from("Mutant #7890")],
        [
          Buffer.from("src"),
          Buffer.from("ipfs://QmfD2LyBkgJaceVBude3TG43bj9AEkz5GyrTW8h2MsuNrW"),
        ],
      ]),

      new Map<Buffer, Buffer>([
        [Buffer.from("mediaType"), Buffer.from("image/png")],
        [Buffer.from("name"), Buffer.from("MutantCroc03503")],
        [
          Buffer.from("src"),
          Buffer.from("ipfs://QmRsHximsebdBJF5Mg9tGpeZFQXP6JmwGYeW9MgFC6f2s5"),
        ],
      ]),

      new Map<Buffer, Buffer>([
        [Buffer.from("mediaType"), Buffer.from("image/png")],
        [Buffer.from("name"), Buffer.from("MutantMouse04543")],
        [
          Buffer.from("src"),
          Buffer.from("ipfs://QmeDywGcJiH5YubTb768PTMazrzYZpFEY3od4eevuSRwSP"),
        ],
      ]),
    ]);

    plutusMetadata.set(
      Buffer.from("image"),
      Buffer.from("ipfs://QmfD2LyBkgJaceVBude3TG43bj9AEkz5GyrTW8h2MsuNrW")
    );
    plutusMetadata.set(Buffer.from("mediaType"), Buffer.from("image/png"));
    plutusMetadata.set(Buffer.from("name"), Buffer.from("Mutant #7890"));

    const plutusData = {
      constructor: 0,
      fields: [
        {
          map: plutusMetadata,
        },
        {
          int: 1,
        },
        {
          plutusData: {
            constructor: 0,
            fields: [{ map: new Map() }],
          },
        },
      ],
    };

    builder.setPlutusDatas([plutusData]);

    builder.setRedeemers([
      [RedeemerTag.Spend, 1, { constructor: 0, fields: [] }, [42879, 15615619]],
    ]);

    builder.calculateFee();

    expect(builder.serialize()).toBe(
      // Generated by lucid: "84a80082825820d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e0082582021b0180070427f7be4869d6fde9e74757d51ee7afffa8b8d92fd17ab0c8c473301018282583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2821a0012050ca1581c2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411a14e000643b04d5554414e54373839300182583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b21a00b2c42d021a0003a4ce0b58208a9fd1eb2ad588fd32f71b5f7716a88ad27964a4213146df09bfbb233eca500f0d81825820dd0c087733b576ed3fb415137afdb9bbf00712b7137c5687f180f8e6e30245d1010e81581c675061014f3eace588951de4b7fab2dc0a7b4ba16c2944dace6ed5051082583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2821a09fed1eda3581c2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411b14e000de1404d5554414e5433313634014e000de1404d5554414e5433323233014e000de1404d5554414e5433333238014e000de1404d5554414e5434333138014e000de1404d5554414e5434333731014e000de1404d5554414e5434343434014e000de1404d5554414e5434363838014e000de1404d5554414e5435313939014e000de1404d5554414e5435353733014e000de1404d5554414e5435363038014e000de1404d5554414e5436323336014e000de1404d5554414e5436343238014e000de1404d5554414e5436353035014e000de1404d5554414e5437313334014e000de1404d5554414e5437343339014e000de1404d5554414e5437363830014e000de1404d5554414e543738393001581c5b2fa063c299c443dbbad0a186574abbdcbbc323318cccb8f207e224a1581a5370616365746f6b656e73466f756e646572734e46543130343501581c6194158d24d71eca5cc5601c45de123bf78d02c297e851be2608810aa1444445414414111a00057735a3049fd8799fa54a61747472696275746573a84a4261636b67726f756e6445426569676545436c6f7468524d54545320507572706c6520486f6f64696543456172444e6f6e65444579657346436c6f73656444486561644d4f72616e6765204265616e6965454d6f75746845536d69726b444e6f736546436f6d6d6f6e44536b696e46507572706c654566696c65739fa3496d656469615479706549696d6167652f706e67446e616d654c4d7574616e74202337383930437372635835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257a3496d656469615479706549696d6167652f706e67446e616d654f4d7574616e7443726f633033353033437372635835697066733a2f2f516d52734878696d73656264424a46354d6739744770655a46515850364a6d7747596557394d6746433666327335a3496d656469615479706549696d6167652f706e67446e616d65504d7574616e744d6f7573653034353433437372635835697066733a2f2f516d6544797747634a694835597562546237363850544d617a727a595a70464559336f6434656576755352775350ff45696d6167655835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257496d656469615479706549696d6167652f706e67446e616d654c4d7574616e7420233738393001d8799fa0ffffff0581840001d879808219a77f1a00ee4683068158c058be010000332323232323232323232232222533300a32001323233001375866010601466010601400690002402000c6002002444a66602000429404c8c94ccc03ccdc78010018a5113330050050010033013003375c60220042930b1bae00133001001480008888cccc01ccdc38008018059199980280299b8000448008c0340040080088c014dd5000918019baa0015734aae7555cf2ab9f5742ae8930011e581c675061014f3eace588951de4b7fab2dc0a7b4ba16c2944dace6ed5050001f5f6"
      // Should we try to get to the same value or is the difference just because of the indefinite-length plutus data they are using?
      "84a80082825820d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e0082582021b0180070427f7be4869d6fde9e74757d51ee7afffa8b8d92fd17ab0c8c4733010182a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b201821a0012050ca1581c2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411a14e000643b04d5554414e543738393001a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a00b2c42d021a000497260b58207e00ef9a1a00e610b435e9f173131c1a6d911d568195caec64bb72a468fe12330d81825820dd0c087733b576ed3fb415137afdb9bbf00712b7137c5687f180f8e6e30245d1010e81581c675061014f3eace588951de4b7fab2dc0a7b4ba16c2944dace6ed50510a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b201821a09fd6669a3581c2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411b14e000de1404d5554414e5433313634014e000de1404d5554414e5433323233014e000de1404d5554414e5433333238014e000de1404d5554414e5434333138014e000de1404d5554414e5434333731014e000de1404d5554414e5434343434014e000de1404d5554414e5434363838014e000de1404d5554414e5435313939014e000de1404d5554414e5435353733014e000de1404d5554414e5435363038014e000de1404d5554414e5436323336014e000de1404d5554414e5436343238014e000de1404d5554414e5436353035014e000de1404d5554414e5437313334014e000de1404d5554414e5437343339014e000de1404d5554414e5437363830014e000de1404d5554414e543738393001581c5b2fa063c299c443dbbad0a186574abbdcbbc323318cccb8f207e224a1581a5370616365746f6b656e73466f756e646572734e46543130343501581c6194158d24d71eca5cc5601c45de123bf78d02c297e851be2608810aa1444445414414111a0006e2b9a30481d87983a54a61747472696275746573a84a4261636b67726f756e6445426569676545436c6f7468524d54545320507572706c6520486f6f64696543456172444e6f6e65444579657346436c6f73656444486561644d4f72616e6765204265616e6965454d6f75746845536d69726b444e6f736546436f6d6d6f6e44536b696e46507572706c654566696c657383a3496d656469615479706549696d6167652f706e67446e616d654c4d7574616e74202337383930437372635835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257a3496d656469615479706549696d6167652f706e67446e616d654f4d7574616e7443726f633033353033437372635835697066733a2f2f516d52734878696d73656264424a46354d6739744770655a46515850364a6d7747596557394d6746433666327335a3496d656469615479706549696d6167652f706e67446e616d65504d7574616e744d6f7573653034353433437372635835697066733a2f2f516d6544797747634a694835597562546237363850544d617a727a595a70464559336f643465657675535277535045696d6167655835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257496d656469615479706549696d6167652f706e67446e616d654c4d7574616e7420233738393001d87981a00581840001d879808219a77f1a00ee4683068158c058be010000332323232323232323232232222533300a32001323233001375866010601466010601400690002402000c6002002444a66602000429404c8c94ccc03ccdc78010018a5113330050050010033013003375c60220042930b1bae00133001001480008888cccc01ccdc38008018059199980280299b8000448008c0340040080088c014dd5000918019baa0015734aae7555cf2ab9f5742ae8930011e581c675061014f3eace588951de4b7fab2dc0a7b4ba16c2944dace6ed5050001f5f6"
    );
  });

  test("should serialize the transaction correctly (With inline datum)", () => {
    const builder = new TransactionBuilder();

    builder.setInputs([
      {
        txHash:
          "2f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3",
        txIndex: 0,
      },
      {
        txHash:
          "e3fb72d0e4a43b628cbcd700681fb4d1a374c9c3a6efb9abbdffd1ed8b7148ba",
        txIndex: 0,
      },
      {
        txHash:
          "d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e",
        txIndex: 0,
      },
      {
        txHash:
          "d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e",
        txIndex: 2,
      },
      {
        txHash:
          "d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e",
        txIndex: 1,
      },
    ]);

    builder.setOutputs([
      {
        address: toPaymentAddress(
          "71571562b26410dfd95b8d6c64003784134b48cf17cf9910080386bf1c"
        ),
        value: {
          coin: 3469550,
          assets: {
            "2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411": {
              "000643b04d5554414e5437383930": 1n,
            },
          },
        },
        datumInlined:
          "d8799fa54a61747472696275746573a84a4261636b67726f756e6445426569676545436c6f7468524d54545320507572706c6520486f6f64696543456172444e6f6e65444579657346436c6f73656444486561644d4f72616e6765204265616e6965454d6f75746845536d69726b444e6f736546436f6d6d6f6e44536b696e46507572706c654566696c65739fa3496d656469615479706549696d6167652f706e67446e616d654c4d7574616e74202337383930437372635835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257a3496d656469615479706549696d6167652f706e67446e616d654f4d7574616e7443726f633033353033437372635835697066733a2f2f516d52734878696d73656264424a46354d6739744770655a46515850364a6d7747596557394d6746433666327335a3496d656469615479706549696d6167652f706e67446e616d65504d7574616e744d6f7573653034353433437372635835697066733a2f2f516d6544797747634a694835597562546237363850544d617a727a595a70464559336f6434656576755352775350ff45696d6167655835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257496d656469615479706549696d6167652f706e67446e616d654c4d7574616e7420233738393001d8799fa0ffff",
      },
      {
        address: toPaymentAddress(
          "01c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2"
        ),
        value: {
          coin: 87968888,
        },
      },
    ]);

    builder.setEncodedVKeyWitnesses(
      "a100818258209b3667e7d92d74c1efcb7eb4e0e2157dc2d6334b87167833eede33d766609624584001401ac7fed02646cd4828d7fcc857d349de145e6fbf80c0d0c5b9d00899601d312129eade35c3c5add0abfcaf937d04fe4cd21af698055cee9a097f3590910f"
    );

    builder.calculateFee();

    expect(builder.serialize()).toBe(
      "84a30085825820d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e00825820d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e01825820d3d5bb30a2a7dce6c1d2202f7c0f089bd137a4d73c6f5454ccec81b8e587423e02825820e3fb72d0e4a43b628cbcd700681fb4d1a374c9c3a6efb9abbdffd1ed8b7148ba008258202f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3000182a300581d71571562b26410dfd95b8d6c64003784134b48cf17cf9910080386bf1c01821a0034f0eea1581c2d37295347d9fbd197ecfd0e4ddef32ef757083c23985049326a5411a14e000643b04d5554414e543738393001028201d818590225d8799fa54a61747472696275746573a84a4261636b67726f756e6445426569676545436c6f7468524d54545320507572706c6520486f6f64696543456172444e6f6e65444579657346436c6f73656444486561644d4f72616e6765204265616e6965454d6f75746845536d69726b444e6f736546436f6d6d6f6e44536b696e46507572706c654566696c65739fa3496d656469615479706549696d6167652f706e67446e616d654c4d7574616e74202337383930437372635835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257a3496d656469615479706549696d6167652f706e67446e616d654f4d7574616e7443726f633033353033437372635835697066733a2f2f516d52734878696d73656264424a46354d6739744770655a46515850364a6d7747596557394d6746433666327335a3496d656469615479706549696d6167652f706e67446e616d65504d7574616e744d6f7573653034353433437372635835697066733a2f2f516d6544797747634a694835597562546237363850544d617a727a595a70464559336f6434656576755352775350ff45696d6167655835697066733a2f2f516d6644324c79426b674a61636556427564653354473433626a3941456b7a3547797254573868324d73754e7257496d656469615479706549696d6167652f706e67446e616d654c4d7574616e7420233738393001d8799fa0ffffa200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a053e4c78021a0003ba25a100818258209b3667e7d92d74c1efcb7eb4e0e2157dc2d6334b87167833eede33d766609624584001401ac7fed02646cd4828d7fcc857d349de145e6fbf80c0d0c5b9d00899601d312129eade35c3c5add0abfcaf937d04fe4cd21af698055cee9a097f3590910ff5f6"
    );
  });

  describe("setEncodedVKeyWitnesses", () => {
    let builder: TransactionBuilder;

    beforeEach(() => {
      builder = new TransactionBuilder();

      builder.setInputs([
        {
          txHash:
            "2f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3",
          txIndex: 0,
        },
      ]);

      builder.setOutputs([
        {
          address: toPaymentAddress(
            "01c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2"
          ),
          value: {
            coin: 87968888,
          },
        },
      ]);
    });

    test("when the encoded vkey witnesses is a Map", () => {
      builder.setEncodedVKeyWitnesses(
        "a100818258209b3667e7d92d74c1efcb7eb4e0e2157dc2d6334b87167833eede33d766609624584001401ac7fed02646cd4828d7fcc857d349de145e6fbf80c0d0c5b9d00899601d312129eade35c3c5add0abfcaf937d04fe4cd21af698055cee9a097f3590910f"
      );

      builder.calculateFee();

      expect(builder.serialize()).toBe(
        "84a300818258202f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3000181a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a053e4c78021a0002aaeda100818258209b3667e7d92d74c1efcb7eb4e0e2157dc2d6334b87167833eede33d766609624584001401ac7fed02646cd4828d7fcc857d349de145e6fbf80c0d0c5b9d00899601d312129eade35c3c5add0abfcaf937d04fe4cd21af698055cee9a097f3590910ff5f6"
      );
    });

    test("when the encoded vkey witnesses is an array", () => {
      builder.setEncodedVKeyWitnesses(
        "818258209b3667e7d92d74c1efcb7eb4e0e2157dc2d6334b87167833eede33d766609624584001401ac7fed02646cd4828d7fcc857d349de145e6fbf80c0d0c5b9d00899601d312129eade35c3c5add0abfcaf937d04fe4cd21af698055cee9a097f3590910f"
      );

      builder.calculateFee();

      expect(builder.serialize()).toBe(
        "84a300818258202f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3000181a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a053e4c78021a0002aaeda100818258209b3667e7d92d74c1efcb7eb4e0e2157dc2d6334b87167833eede33d766609624584001401ac7fed02646cd4828d7fcc857d349de145e6fbf80c0d0c5b9d00899601d312129eade35c3c5add0abfcaf937d04fe4cd21af698055cee9a097f3590910ff5f6"
      );
    });

    test("when the encoded vkey witnesses is a map but there is no array", () => {
      builder.setEncodedVKeyWitnesses("a10000");

      builder.calculateFee();

      expect(builder.serialize()).toBe(
        "84a300818258202f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3000181a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a053e4c78021a00028785a0f5f6"
      );
    });

    test("when the encoded vkey witnesses is invalid (not an array not map)", () => {
      builder.setEncodedVKeyWitnesses("00");

      builder.calculateFee();

      expect(builder.serialize()).toBe(
        "84a300818258202f1260560b0a4a4c9b0e5d3b5e6b11bae465a06c5009790fab82fe33c9cb4fe3000181a200583901c59dc72ab0bd904dc9a430bd0b6d9d3b3c2d32dfa3dcf5affd309002fa02bb733c2b7f9684260bc4b53fb8655cb4b31bfd879a127cf684b2011a053e4c78021a00028785a0f5f6"
      );
    });
  });
});
